
/* Table: TAB_MAIN, Owner: SYSDBA */

CREATE TABLE "TAB_MAIN" 
(
  "T_INKEY"	INTEGER NOT NULL,
  "DATE_TIME"	TIMESTAMP NOT NULL,
  "SOURCE_TYPE"	VARCHAR(25) CHARACTER SET WIN1251,
  "T_OPERATOR"	VARCHAR(50) CHARACTER SET WIN1251,
  "TEMA"	VARCHAR(25) CHARACTER SET WIN1251,
  "OFFER"	VARCHAR(15) CHARACTER SET WIN1251,
  "PRIMECHANIE"	VARCHAR(100) CHARACTER SET WIN1251,
  "IS_SUCSESS"	INTEGER DEFAULT 0 NOT NULL,
  "DEST"	VARCHAR(200) CHARACTER SET WIN1251,
  "DATA"	BLOB SUB_TYPE TEXT SEGMENT SIZE 80 CHARACTER SET WIN1251,
  "APPLICATION"	BLOB SUB_TYPE 0 SEGMENT SIZE 80,
  "WITH_APPLICATION"	VARCHAR(200) CHARACTER SET WIN1251 DEFAULT 'no' NOT NULL,
 PRIMARY KEY ("T_INKEY")
);
SET TERM ^ ;


/* Triggers only will work for SQL triggers */

CREATE TRIGGER "INSERT_TRIG" FOR "TAB_MAIN" 
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  new.T_INKEY = gen_ID(genforid,1);
  new.DATE_TIME = 'now';
  if(new.APPLICATION is null) then
   begin
   new.WITH_APPLICATION = 'no';
   end
end
 ^

CREATE TRIGGER "HISTORY_TRIG" FOR "TAB_MAIN" 
ACTIVE BEFORE UPDATE POSITION 0
AS

begin
  if(NEW.OFFER != OLD.OFFER) then 
  begin
  insert into HISTORY_TAB values(old.t_inkey,'NOW',new.OFFER);
  NEW.OFFER = OLD.OFFER;
  end
end
 ^

COMMIT WORK ^
SET TERM ;^

